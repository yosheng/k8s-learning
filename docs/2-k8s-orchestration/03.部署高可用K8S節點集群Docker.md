# Kubeadm 高可用環境準備

節點規劃如下

| 主機IP          | 主機名      | 主機配置  | 角色        |
| ------------- | -------- | ----- | --------- |
| 192.168.0.20  | master01 | 2C/4G | 管理節點      |
| 192.168.0.21  | master02 | 2C/4G | 管理節點      |
| 192.168.0.22  | master03 | 2C/4G | 管理節點      |
| 192.168.0.23  | worker01 | 2C/4G | 工作節點      |
| 192.168.0.23  | worker01 | 2C/4G | 工作節點      |
| 192.168.0.70  | k8s-ha1  | 1C/2G | LB        |
| 192.168.0.71  | k8s-ha2  | 1C/2G | LB        |
| 192.168.0.100 | /        | /     | VIP(虛擬IP) |

虛擬機配置完成後需要調整主機名稱

```shell
hostnamectl set-hostname master01
hostnamectl set-hostname master02
hostnamectl set-hostname master03
hostnamectl set-hostname worker01
hostnamectl set-hostname worker0
hostnamectl set-hostname k8s-ha1
hostnamectl set-hostname k8s-ha2
```

如下圖，接著重啟

![](images/03.部署高可用K8S節點集群Docker/2025-11-01-23-26-42-image.png)配置集群之間本地解析，集群在初始化時需要能夠解析主機名

```shell
echo "192.168.0.10 master01" >> /etc/hosts
echo "192.168.0.11 master02" >> /etc/hosts
echo "192.168.0.12 master03" >> /etc/hosts
echo "192.168.0.13 worker01" >> /etc/hosts
echo "192.168.0.14 worker02" >> /etc/hosts
echo "192.168.0.70 k8s-ha1" >> /etc/hosts
echo "192.168.0.71 k8s-ha2" >> /etc/hosts
```

開啟bridge網橋過濾功能

bridge(橋接) 是 Linux 系統中的一種虛擬網絡設備，它充當一個虛擬的交換機，為集群內的容器提供網絡通信功能，容器就可以通過這個 bridge 與其他容器或外部網絡通信了。

```shell
cat > /etc/sysctl.d/k8s.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

#參數解釋
net.bridge.bridge-nf-call-ip6tables = 1  //對網橋上的IPv6數據包通過iptables處理
net.bridge.bridge-nf-call-iptables = 1   //對網橋上的IPv4數據包通過iptables處理
net.ipv4.ip_forward = 1       //開啟IPv4路由轉發,來實現集群中的容器與外部網絡的通信
```

執行下面命令

```shell
#由於開啟bridge功能，需要加載br_netfilter模塊來允許在bridge設備上的數據包經過iptables防火牆處理
modprobe br_netfilter && lsmod | grep br_netfilte

#參數解釋：
modprobe        //命令可以加載內核模塊
br_netfilter    //模塊模塊允許在bridge設備上的數據包經過iptables防火牆處理r
```

如下圖察看結果

![](images/03.部署高可用K8S節點集群Docker/2025-11-03-23-33-52-image.png)

重新加載配置

```shell
sysctl -p /etc/sysctl.d/k8s.conf
```

## 配置ipvs功能

在k8s中Service有兩種代理模式，一種是基於iptables的，一種是基於ipvs，兩者對比ipvs負載均衡算法更加的靈活，且帶有健康檢查的功能，如果想要使用ipvs模式，需要手動載入ipvs模塊。

ipset 和 ipvsadm 是兩個與網絡管理和負載均衡相關的軟件包，在k8s代理模式中，提供多種負載均衡算法，如輪詢（Round Robin）、最小連接（Least Connection）和加權最小連接（Weighted Least Connection）等；

```shell
yum -y install ipset ipvsadm
```

將需要加載的ipvs相關模塊寫入到文件中

```shell
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
EOF

#模塊介紹
ip_vs //提供負載均衡的模塊,支持多種負載均衡算法,如輪詢、最小連接、加權最小連接等
ip_vs_rr //輪詢算法的模塊（默認算法）
ip_vs_wrr //加權輪詢算法的模塊,根據後端服務器的權重值轉發請求
ip_vs_sh //哈希算法的模塊,同一客戶端的請求始終被分發到相同的後端服務器,保證會話一致性
nf_conntrack //鏈接跟蹤的模塊,用於跟蹤一個連接的狀態,例如 TCP 握手、數據傳輸和連接關閉等
```

執行文件來加載模塊

```shell
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack
```

![](images/03.部署高可用K8S節點集群Docker/2025-11-03-23-40-46-image.png)

## 關閉SWAP分區

為了保證 kubelet 正常工作，k8s強制要求禁用，否則集群初始化失敗

```shell
#臨時關閉
swapoff -a

#永久關閉
sed -ri 's/.*swap.*/#&/' /etc/fstab
grep ".*swap.*" /etc/fstab
```

## 檢查swap

```shell
free -h
```

![](images/03.部署高可用K8S節點集群Docker/2025-11-03-23-43-03-image.png)

## Docker 環境準備

> 所有集群主机安装，不包括负载均衡节点

先使用 FileZilla 上傳 docker.tar.gz 接著輸入下面命令安裝

```shell
# 解壓縮
tar -xf docker.tar.gz
cd docker

# 離線安裝
yum install -y ./*.rpm
```

### 配置Cgroup驅動程序

啟用Cgroup控制組，用於限制進程的資源使用量，如CPU、內存資源

```shell
# 在/etc/docker/daemon.json添加如下內容
mkdir /etc/docker
cat > /etc/docker/daemon.json <<EOF
{
        "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF

# 啟動Docker
systemctl start docker
systemctl enable docker
systemctl status docker
```

![](images/03.部署高可用K8S節點集群Docker/2025-11-04-00-05-32-image.png)

## 安裝K8S

這部分邏輯跟單節點保持一致，同樣要先配置下載倉庫

```shell
cat > /etc/yum.repos.d/k8s.repo <<EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

接著輸入下面指令，還是三者都要安裝並指定版本

```shell
yum install -y --nogpgcheck kubeadm-1.23.0-0  kubelet-1.23.0-0 kubectl-1.23.0-0
```

![](images/03.部署高可用K8S節點集群Docker/2025-11-04-00-34-15-image.png)

### 配置 Cgroup 控制組

用於限制進程的資源使用量，如CPU、內存資源

```shell
tee > /etc/sysconfig/kubelet <<EOF
KUBELET_EXTRA_ARGS="--cgroup-driver=systemd"
EOF
```

接著先配置開機自動啟動

```shell
systemctl enable kubelet
```


